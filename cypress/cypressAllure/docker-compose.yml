# =============================================================================
# CYPRESS E2E TESTING - Docker Configuration
# =============================================================================
# Uses official Cypress Docker images which include all browser dependencies
# pre-installed, avoiding local environment issues.
#
# Usage:
#   docker compose up --build           # Run all tests
#   docker compose run --rm cypress     # Interactive run
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Test Application Server
  # ---------------------------------------------------------------------------
  test-app:
    build:
      context: ./cypress/test-app
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"require('http').get('http://localhost:3000', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\"" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Cypress Test Runner
  # ---------------------------------------------------------------------------
  cypress:
    image: cypress/included:13.17.0
    depends_on:
      test-app:
        condition: service_healthy
    environment:
      - CYPRESS_baseUrl=http://test-app:3000
      - XDG_RUNTIME_DIR=/tmp
    working_dir: /e2e
    volumes:
      - ./:/e2e
      - ./reports:/e2e/reports
    command: [ "run", "--headed", "--env", "allure=true" ]
